<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="1" author="skills team">

        <!-- ============================================================================
        Table: Skills Locks
        ============================================================================-->
        <createTable tableName="skills_db_locks">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="lock" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_skills_db_locks_lock"
                     tableName="skills_db_locks" unique="true">
            <column name="lock" type="varchar(255)"/>
        </createIndex>
        <insert tableName="skills_db_locks">
            <column name="lock" type="varchar(255)" value="projects_lock"/>
        </insert>
        <insert tableName="skills_db_locks">
            <column name="lock" type="varchar(255)" value="global_badges_lock"/>
        </insert>
        <insert tableName="skills_db_locks">
            <column name="lock" type="varchar(255)" value="global_settings_lock"/>
        </insert>

        <!-- ============================================================================
        Table: Project Definition
        ============================================================================-->
        <createTable tableName="project_definition">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="project_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="client_secret" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="total_points" type="int" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_project_definition_project_id"
                     tableName="project_definition" unique="true">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_project_definition_name"
                     tableName="project_definition" unique="true">
            <column name="name" type="varchar(255)"/>
        </createIndex>

        <!-- ============================================================================
        Table: Custom Icons
        ============================================================================-->
        <createTable tableName="custom_icons">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <!-- optional, can be null for 'global' badges -->
            <column name="project_id" type="varchar(255)">
            </column>
            <column name="proj_ref_id" type="int"/>
            <column name="filename" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="content_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="data_uri" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="width" type="int">
                <constraints nullable="false" />
            </column>
            <column name="height" type="int">
                <constraints nullable="false" />
            </column>
            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_custom_icons_project_id"
                     tableName="custom_icons">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_custom_icons_filename"
                     tableName="custom_icons">
            <column name="filename" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_custom_icons_project_id_filename"
                     tableName="custom_icons" unique="true">
            <column name="project_id" type="varchar(255)"/>
            <column name="filename" type="varchar(255)"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="project_id"
                                 baseTableName="custom_icons"
                                 constraintName="fk_custom_icons_project_definition_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>
        <addForeignKeyConstraint baseColumnNames="proj_ref_id"
                                 baseTableName="custom_icons"
                                 constraintName="fk_custom_icons_proj_ref_id_project_definition_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="project_definition"/>

        <!-- ============================================================================
        Table: Skill Definition
        ============================================================================-->
        <createTable tableName="skill_definition">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <!-- optional, can be null for 'global' badges -->
            <column name="project_id" type="varchar(255)"/>

            <column name="skill_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <!-- optional, only if immediate child of project -->
            <column name="proj_ref_id" type="int"/>

            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="point_increment" type="int" defaultValue="100">
                <constraints nullable="false"/>
            </column>
            <column name="point_increment_interval" type="int" defaultValue="8">
                <constraints nullable="false"/>
            </column>
            <column name="increment_interval_max_occurrences" type="int" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="total_points" type="int" defaultValue="200">
                <constraints nullable="false"/>
            </column>

            <!-- optional -->
            <column name="description" type="text"/>
            <column name="help_url" type="text"/>

            <column name="display_order" type="int">
                <constraints nullable="false"/>
            </column>

            <column name="type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <!-- optional -->
            <column name="custom_icon_ref_id" type="int"/>
            <column name="icon_class" type="varchar(255)"/>

            <!-- optional, only used for 'gem' badges currently -->
            <column name="start_date" type="DATETIME" />
            <column name="end_date" type="DATETIME" />

            <column name="version" type="int" defaultValue="0">
                <constraints nullable="false"/>
            </column>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_skill_definition_project_id"
                     tableName="skill_definition">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_skill_definition_skill_id"
                     tableName="skill_definition">
            <column name="skill_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_skill_definition_name"
                     tableName="skill_definition">
            <column name="name" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_skill_definition_type"
                     tableName="skill_definition">
            <column name="type" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_skill_definition_version"
                     tableName="skill_definition">
            <column name="version" type="int"/>
        </createIndex>

        <createIndex indexName="index_skill_definition_project_id_skill_id"
                     tableName="skill_definition" unique="true">
            <column name="project_id" type="varchar(255)"/>
            <column name="skill_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_skill_definition_project_id_skill_id_type"
                     tableName="skill_definition" unique="true">
            <column name="project_id" type="varchar(255)"/>
            <column name="skill_id" type="varchar(255)"/>
            <column name="type" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_skill_definition_project_id_name_type"
                     tableName="skill_definition" unique="true">
            <column name="project_id" type="varchar(255)"/>
            <column name="name" type="varchar(255)"/>
            <column name="type" type="varchar(255)"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="project_id"
                                 baseTableName="skill_definition"
                                 constraintName="fk_skill_definition_project_definition_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>
        <addForeignKeyConstraint baseColumnNames="proj_ref_id"
                                 baseTableName="skill_definition"
                                 constraintName="fk_skill_definition_proj_ref_id_project_definition_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="project_definition"/>
        <addForeignKeyConstraint baseColumnNames="custom_icon_ref_id"
                                 baseTableName="skill_definition"
                                 constraintName="fk_skill_definition_custom_icon_id_custom_icons_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="custom_icons"/>

        <!-- ============================================================================
        Table: Skill Relationship Definition
        ============================================================================-->
        <createTable tableName="skill_relationship_definition">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="parent_ref_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="child_ref_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_skill_relationship_definition_parent"
                     tableName="skill_relationship_definition">
            <column name="parent_ref_id" type="int"/>
        </createIndex>
        <createIndex indexName="index_skill_relationship_definition_child"
                     tableName="skill_relationship_definition">
            <column name="child_ref_id" type="int"/>
        </createIndex>
        <createIndex indexName="index_skill_relationship_definition_type"
                     tableName="skill_relationship_definition">
            <column name="type" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_skill_relationship_definition_parent_type"
                     tableName="skill_relationship_definition" unique="false">
            <column name="parent_ref_id" type="int"/>
            <column name="type" type="int"/>
        </createIndex>
        <createIndex indexName="index_skill_relationship_definition_child_type"
                     tableName="skill_relationship_definition" unique="false">
            <column name="child_ref_id" type="int"/>
            <column name="type" type="int"/>
        </createIndex>
        <createIndex indexName="index_skill_relationship_definition_parent_child_type"
                     tableName="skill_relationship_definition" unique="true">
            <column name="parent_ref_id" type="int"/>
            <column name="child_ref_id" type="int"/>
            <column name="type" type="int"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="parent_ref_id"
                                 baseTableName="skill_relationship_definition"
                                 constraintName="fk_skill_rel_parent_id_skill_def_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="child_ref_id"
                                 baseTableName="skill_relationship_definition"
                                 constraintName="fk_skill_rel_child_ref_id_skill_def_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>

        <!-- ============================================================================
        Table: Skill Relationship Definition
        ============================================================================-->
        <createTable tableName="skill_share_definition">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="skill_ref_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="shared_to_project_ref_id" type="int">
                <constraints nullable="true"/>
            </column>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_skill_share_definition_skill_id_shared_to_project_id"
                     tableName="skill_share_definition" unique="true">
            <column name="skill_ref_id" type="int"/>
            <column name="shared_to_project_ref_id" type="int"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="skill_ref_id"
                                 baseTableName="skill_share_definition"
                                 constraintName="fk_skill_id_skill_share_definition_skill_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="shared_to_project_ref_id"
                                 baseTableName="skill_share_definition"
                                 constraintName="fk_skill_id_skill_share_definition_shared_to_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="project_definition"/>

        <!-- ============================================================================
        Table: Level Definition
        ============================================================================-->
        <createTable tableName="level_definition">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <!-- optional, either belong to project or skill -->
            <column name="project_ref_id" type="int"/>
            <column name="skill_ref_id" type="int"/>

            <column name="level" type="int">
                <constraints nullable="false"/>
            </column>

            <!-- optional, either percent or points -->
            <column name="percent" type="int"/>
            <column name="points_from" type="int"/>
            <column name="points_to" type="int"/>

            <!-- optional -->
            <column name="custom_icon_ref_id" type="int"/>
            <column name="icon_class" type="varchar(255)"/>
            <column name="logical_name" type="varchar(255)"/>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_level_definition_project_id"
                     tableName="level_definition">
            <column name="project_ref_id" type="int"/>
        </createIndex>
        <createIndex indexName="index_level_definition_skill_id"
                     tableName="level_definition">
            <column name="skill_ref_id" type="int"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="skill_ref_id"
                                 baseTableName="level_definition"
                                 constraintName="fk_skill_definition_skill_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="project_ref_id"
                                 baseTableName="level_definition"
                                 constraintName="fk_skill_definition_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="project_definition"/>

        <!-- ============================================================================
        Table: User Attributes
        ============================================================================-->
        <createTable tableName="user_attrs">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="first_name" type="varchar(255)"/>
            <column name="last_name" type="varchar(255)"/>
            <column name="dn" type="varchar(255)"/>
            <column name="email" type="varchar(255)"/>
            <column name="nickname" type="varchar(255)"/>
            <column name="user_id_for_display" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_users_attrs_user_id"
                     tableName="user_attrs" unique="true">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>

        <!-- ============================================================================
        Table: Users
        ============================================================================-->
        <createTable tableName="users">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="varchar(255)"/>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_users_user_id"
                     tableName="users" unique="true">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="users"
                                 constraintName="fk_users_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="user_id"
                                 referencedTableName="user_attrs"/>

        <!-- ============================================================================
        Table: User Roles
        ============================================================================-->
        <createTable tableName="user_roles">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="user_ref_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="role_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="project_id" type="varchar(255)"/>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_user_roles_user_id"
                     tableName="user_roles">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_user_roles_user_id_role_name_project_id"
                     tableName="user_roles" unique="true">
            <column name="user_id" type="varchar(255)"/>
            <column name="role_name" type="varchar(255)"/>
            <column name="project_id" type="varchar(255)"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="user_ref_id"
                                 baseTableName="user_roles"
                                 constraintName="fk_user_roles_user_ref_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="users"/>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="user_roles"
                                 constraintName="fk_user_roles_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="user_id"
                                 referencedTableName="users"/>
        <addForeignKeyConstraint baseColumnNames="project_id"
                                 baseTableName="user_roles"
                                 constraintName="fk_user_roles_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>

        <!-- ============================================================================
        Table: User Performed Skill
        ============================================================================-->
        <createTable tableName="user_performed_skill">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="skill_ref_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="skill_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="project_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="performed_on" type="datetime">
                <constraints nullable="false"/>
            </column>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_user_performed_skill_user_id"
                     tableName="user_performed_skill">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_user_performed_skill_project_id"
                     tableName="user_performed_skill">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_user_performed_skill_skill_id"
                     tableName="user_performed_skill">
            <column name="skill_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_user_performed_skill_skill_ref_id"
                     tableName="user_performed_skill">
            <column name="skill_ref_id" type="int"/>
        </createIndex>
        <createIndex indexName="index_user_performed_skill_performed_on"
                     tableName="user_performed_skill">
            <column name="performed_on" type="datetime"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="skill_ref_id"
                                 baseTableName="user_performed_skill"
                                 constraintName="fk_user_performed_skill_skill_ref_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="project_id,skill_id"
                                 baseTableName="user_performed_skill"
                                 constraintName="fk_user_performed_skill_proj_id_skill_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id,skill_id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="user_performed_skill"
                                 constraintName="fk_user_performed_skill_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="user_id"
                                 referencedTableName="user_attrs"/>

        <!-- ============================================================================
        Table: User Points
        ============================================================================-->
        <createTable tableName="user_points">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="project_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="skill_ref_id" type="int"/>
            <column name="skill_id" type="varchar(255)"/>
            <column name="points" type="int">
                <constraints nullable="false"/>
            </column>

            <column name="day" type="date"/>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_user_points_project_id"
                     tableName="user_points">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_user_points_skill_ref_id"
                     tableName="user_points">
            <column name="skill_ref_id" type="int"/>
        </createIndex>
        <createIndex indexName="index_user_points_skill_id"
                     tableName="user_points">
            <column name="skill_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_user_points_user_id"
                     tableName="user_points">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_user_points_day"
                     tableName="user_points">
            <column name="day" type="date"/>
        </createIndex>
        <createIndex indexName="index_user_points_points"
                     tableName="user_points">
            <column name="points" type="int"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="project_id"
                                 baseTableName="user_points"
                                 constraintName="fk_user_points_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>
        <addForeignKeyConstraint baseColumnNames="skill_ref_id"
                                 baseTableName="user_points"
                                 constraintName="fk_user_points_skill_ref_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="project_id,skill_id"
                                 baseTableName="user_points"
                                 constraintName="fk_user_points_proj_id_skill_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id,skill_id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="user_points"
                                 constraintName="fk_user_points_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="user_id"
                                 referencedTableName="user_attrs"/>

        <createIndex indexName="user_points_proj_skill_user_day"
                     tableName="user_points" unique="true">
            <column name="project_id" type="varchar(255)"/>
            <column name="skill_id" type="varchar(255)"/>
            <column name="user_id" type="varchar(255)"/>
            <column name="day" type="date"/>
        </createIndex>


        <!-- ============================================================================
        Table: User Achievement
        ============================================================================-->
        <createTable tableName="user_achievement">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <!-- optional, can be null for 'global' badges -->
            <column name="project_id" type="varchar(255)"/>

            <column name="skill_id" type="varchar(255)"/>
            <column name="skill_ref_id" type="int"/>

            <column name="level" type="int"/>
            <column name="points_when_achieved" type="int">
                <constraints nullable="false"/>
            </column>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_user_achievement_user_id"
                     tableName="user_achievement">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_user_achievement_skill_id"
                     tableName="user_achievement">
            <column name="skill_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_user_achievement_skill_ref_id"
                     tableName="user_achievement">
            <column name="skill_ref_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_user_achievement_project_id"
                     tableName="user_achievement">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="skill_ref_id"
                                 baseTableName="user_achievement"
                                 constraintName="fk_user_achievement_skill_ref_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="project_id"
                                 baseTableName="user_achievement"
                                 constraintName="fk_user_achievement_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>
        <addForeignKeyConstraint baseColumnNames="project_id,skill_id"
                                 baseTableName="user_achievement"
                                 constraintName="fk_user_achievement_proj_id_skill_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id,skill_id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="user_achievement"
                                 constraintName="fk_user_achievement_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="user_id"
                                 referencedTableName="user_attrs"/>

       <!-- ============================================================================
       Table: Settings
       ============================================================================-->
        <createTable tableName="settings">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="setting" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="project_id" type="varchar(255)"/>
            <column name="setting_group" type="varchar(255)"/>
            <column name="user_ref_id" type="int" />

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_settings_project_id"
                     tableName="settings">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_settings_setting_group"
                     tableName="settings">
            <column name="setting_group" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_settings_setting"
                     tableName="settings">
            <column name="setting" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_settings_user_id"
                     tableName="settings">
            <column name="user_ref_id" type="int"/>
        </createIndex>
        <createIndex indexName="index_settings_type"
                     tableName="settings">
            <column name="type" type="varchar(255)"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="project_id"
                                 baseTableName="settings"
                                 constraintName="fk_settings_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>
        <addForeignKeyConstraint baseColumnNames="user_ref_id"
                                 baseTableName="settings"
                                 constraintName="fk_settings_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="users"/>


        <!-- ============================================================================
        Table: Global Badge Level Definition
        ============================================================================-->
        <createTable tableName="global_badge_level_definition">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="proj_ref_id" type="int">
                <constraints nullable="false"/>
            </column>

            <column name="project_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="project_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="skill_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="skill_ref_id" type="int">
                <constraints nullable="false"/>
            </column>

            <column name="level" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="level_ref_id" type="int">
                <constraints nullable="false"/>
            </column>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_global_badge_level_definition_project_ref_id"
                     tableName="global_badge_level_definition">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_global_badge_level_definition_skill_ref_id"
                     tableName="global_badge_level_definition">
            <column name="skill_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_global_badge_level_definition_proj_skill_level"
                     tableName="global_badge_level_definition" unique="true">
            <column name="proj_ref_id" type="int"/>
            <column name="skill_ref_id" type="int"/>
            <column name="level_ref_id" type="int"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="proj_ref_id"
                                 baseTableName="global_badge_level_definition"
                                 constraintName="fk_global_badge_level_definition_proj_ref_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="project_definition"/>
        <addForeignKeyConstraint baseColumnNames="skill_ref_id"
                                 baseTableName="global_badge_level_definition"
                                 constraintName="fk_global_badge_level_skill_ref_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="level_ref_id"
                                 baseTableName="global_badge_level_definition"
                                 constraintName="fk_global_badge_level_level_ref_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="level_definition"/>


        <!-- ============================================================================
        SQL Modifications
        ============================================================================-->
        <modifySql dbms="mysql">
            <!-- Only append for create table statements -->
            <regExpReplace replace="(CREATE TABLE.*)" with="$1 engine innodb"/>
        </modifySql>

    </changeSet>

    <changeSet id="2" author="skills team" context="migration1">
        <addColumn tableName="skill_definition">
            <column name="enabled" type="varchar(255)" defaultValueBoolean="true"/>
        </addColumn>
        <addColumn tableName="user_achievement">
            <column name="notified" type="varchar(255)" defaultValueBoolean="true" />
        </addColumn>
        <sql>
            UPDATE user_achievement SET notified = 'true';
        </sql>

        <createTable tableName="password_reset_token">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="token" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="expires" type="DATETIME" >
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_password_reset_token_user_id"
                     tableName="password_reset_token" unique="true">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_password_reset_token_token"
                     tableName="password_reset_token" unique="true">
            <column name="token" type="varchar(255)"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="password_reset_token"
                                 constraintName="fk_password_reset_token_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="users"/>

        <modifyDataType tableName="settings" columnName="value" newDataType="varchar(3000)" />
    </changeSet>

    <changeSet id="3" author="skills team" context="migration2">
        <addColumn tableName="user_achievement">
            <column name="achieved_on" type="datetime" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </addColumn>
        <sql>
            UPDATE user_achievement ua SET achieved_on=created where project_id is not null;
        </sql>
        <addNotNullConstraint columnDataType="datetime" columnName="achieved_on" tableName="user_achievement"/>
        <createIndex indexName="index_user_achievement_achieved_on" tableName="user_achievement">
            <column name="achieved_on" type="datetime"/>
        </createIndex>
    </changeSet>

    <changeSet id="4" author="skills team" context="migration3">
        <createTable tableName="user_events">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="project_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="skill_ref_id" type="int">
                <constraints nullable="false"/>
            </column>

            <column name="event_time" type="DATETIME">
                <constraints nullable="false"/>
            </column>

            <column name="event_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="count" type="int" />

            <column name="week_number" type="int" />
        </createTable>

        <createIndex indexName="index_user_events_user_id"
                     tableName="user_events">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>

        <createIndex indexName="index_user_events_project_id"
                     tableName="user_events">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>

        <createIndex indexName="index_user_events_skill_ref_id"
                     tableName="user_events">
            <column name="skill_ref_id" type="int"/>
        </createIndex>

        <createIndex tableName="user_events" indexName="index_user_events_week_number">
            <column name="week_number"/>
        </createIndex>

        <createIndex tableName="user_events" indexName="index_user_events_event_time">
            <column name="event_time"/>
        </createIndex>

        <createIndex indexName="index_user_events_event_type" tableName="user_events">
            <column name="event_type" type="varchar(255)"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="user_events"
                                 constraintName="fk_user_events_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="user_id"
                                 referencedTableName="user_attrs"/>

        <addForeignKeyConstraint baseColumnNames="project_id"
                                 baseTableName="user_events"
                                 constraintName="fk_user_events_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>

        <addForeignKeyConstraint baseColumnNames="skill_ref_id"
                                 baseTableName="user_events"
                                 constraintName="fk_user_events_skill_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>

        <addUniqueConstraint
                columnNames="user_id, project_id, skill_ref_id, event_time, event_type"
                constraintName="user_events_unique_row"
                tableName="user_events"/>

        <insert tableName="skills_db_locks">
            <column name="lock" type="varchar(255)" value="event_compaction_lock"/>
        </insert>
    </changeSet>

    <changeSet id="5" author="skills team" context="migration5">
        <addColumn tableName="skill_definition">
            <column name="self_reporting_type" type="varchar(255)"/>
        </addColumn>

        <createTable tableName="skill_approval">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="project_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="skill_ref_id" type="int">
                <constraints nullable="false"/>
            </column>

            <column name="requested_on" type="datetime">
                <constraints nullable="false"/>
            </column>

            <column name="rejected_on" type="datetime">
            </column>

            <column name="request_msg" type="text"/>
            <column name="rejection_msg" type="text"/>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex indexName="index_skill_approval_user_id"
                     tableName="skill_approval">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>

        <createIndex indexName="index_skill_approval_project_id"
                     tableName="skill_approval">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>

        <createIndex indexName="index_skill_approval_skill_ref_id"
                     tableName="skill_approval">
            <column name="skill_ref_id" type="int"/>
        </createIndex>

        <createIndex indexName="index_skill_approval_rejected_on"
                     tableName="skill_approval">
            <column name="rejected_on" type="datetime"/>
        </createIndex>


        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="skill_approval"
                                 constraintName="fk_skill_approval_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="user_id"
                                 referencedTableName="user_attrs"/>

        <addForeignKeyConstraint baseColumnNames="skill_ref_id"
                                 baseTableName="skill_approval"
                                 constraintName="fk_skill_approval_skill_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>

        <addForeignKeyConstraint baseColumnNames="project_id"
                                 baseTableName="skill_approval"
                                 constraintName="fk_skill_approval_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>

        <addUniqueConstraint
                columnNames="user_id, skill_ref_id"
                constraintName="skill_approval_unique_row"
                tableName="skill_approval"/>
    </changeSet>

    <changeSet id="6" author="skills team" context="migration6">
        <createTable tableName="project_error">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="project_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="error_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="error" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="last_seen" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="count" type="int">
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="project_id"
                                 baseTableName="project_error"
                                 constraintName="fk_project_error_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>

        <createIndex indexName="index_project_error_project_id"
                     tableName="project_error">
            <column name="project_id" type="varchar(255)"/>
        </createIndex>

        <createIndex indexName="index_project_error_error"
                     tableName="project_error">
            <column name="error" type="varchar(255)"/>
        </createIndex>

        <createIndex indexName="index_project_error_project_id_error_type"
                     tableName="project_error">
            <column name="error_type" type="varchar(255)"/>
            <column name="project_id" type="varchar(255)"/>
        </createIndex>

        <createIndex indexName="index_project_error_project_id_error_type_error"
                     tableName="project_error">
            <column name="error_type" type="varchar(255)"/>
            <column name="project_id" type="varchar(255)"/>
            <column name="error" type="varchar(255)"/>
        </createIndex>
    </changeSet>

    <changeSet id="7" author="skills team" context="migration7">
        <createTable tableName="notifications">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="requested_on" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="encoded_params" type="text">
                <constraints nullable="false"/>
            </column>

            <column name="failed_count" type="int">
                <constraints nullable="false"/>
            </column>

            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex indexName="notifications_user_id"
                     tableName="notifications">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>

        <createIndex indexName="notifications_requested_on"
                     tableName="notifications">
            <column name="requested_on" type="datetime"/>
        </createIndex>

        <createIndex indexName="notifications_retry_count"
                     tableName="notifications">
            <column name="failed_count" type="int"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="notifications"
                                 constraintName="fk_notifications_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="user_id"
                                 referencedTableName="user_attrs" />

        <insert tableName="skills_db_locks">
            <column name="lock" type="varchar(255)" value="notifier_lock"/>
        </insert>
    </changeSet>

    <changeSet id="8" author="skills team" context="migration8">
        <modifyDataType columnName="value"
                         newDataType="text"
                         tableName="settings"/>
    </changeSet>

    <changeSet id="9" author="skills team" context="migration9">
        <sql>
            delete from settings where setting_group = 'pinned_project' and user_ref_id in (select distinct user_ref_id from user_roles where role_name = 'ROLE_SUPER_DUPER_USER');
            delete from settings where setting_group = 'project_sort_order' and user_ref_id in (select distinct user_ref_id from user_roles where role_name = 'ROLE_SUPER_DUPER_USER');
        </sql>
    </changeSet>

    <changeSet id="10" author="skills team" context="migration10">
        <insert tableName="skills_db_locks">
            <column name="lock" type="varchar(255)" value="project_expiration_lock" />
        </insert>
    </changeSet>

    <changeSet id="11" author="skills team" context="migration11">
        <dropForeignKeyConstraint baseTableName="notifications" constraintName="fk_notifications_user_id" />
        <dropIndex tableName="notifications" indexName="notifications_user_id" />
        <modifyDataType tableName="notifications" columnName="user_id" newDataType="text" />
    </changeSet>

    <changeSet id="12" author="skills team" context="migration12">
        <!-- ============================================================================
        Table: User Tags
        ============================================================================-->
        <createTable tableName="user_tags">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="user_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="key" type="varchar(255)"/>
            <column name="value" type="varchar(255)"/>
            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="index_users_tags_user_id"
                     tableName="user_tags">
            <column name="user_id" type="varchar(255)"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="user_tags"
                                 constraintName="fk_user_tags_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="user_id"
                                 referencedTableName="user_attrs" />

        <addColumn tableName="user_attrs">
            <column name="user_tags_last_updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <insert tableName="skills_db_locks">
            <column name="lock" type="varchar(255)" value="create_or_update_user"/>
        </insert>
    </changeSet>

    <changeSet id="13" author="skills team" context="migration13">
        <dropUniqueConstraint
                constraintName="skill_approval_unique_row"
                tableName="skill_approval" />

        <addColumn tableName="skill_approval">
            <column name="approver_action_taken_on" type="datetime"/>
        </addColumn>
        <addColumn tableName="skill_approval">
            <column name="rejection_acknowledged_on" type="datetime" />
        </addColumn>
        <addColumn tableName="skill_approval">
            <column name="approver_user_id" type="varchar(255)" />
        </addColumn>
        <createIndex indexName="index_skill_approval_approver_action_taken_on"
                     tableName="skill_approval">
            <column name="approver_action_taken_on" type="datetime"/>
        </createIndex>
        <createIndex indexName="index_skill_approval_approver_user_id
"
                     tableName="skill_approval">
            <column name="approver_user_id" type="datetime"/>
        </createIndex>
        <sql>
            update skill_approval set approver_action_taken_on = rejected_on where rejected_on is not null;
            update skill_approval ap set approver_user_id = (select user_id from user_roles ur where ur.project_id = ap.project_id and ur.role_name = 'ROLE_PROJECT_ADMIN' limit 1) where rejected_on is not null;
        </sql>
    </changeSet>

    <changeSet id="14" author="skills team" context="migration14">
        <createIndex indexName="index_users_tags_key"
                     tableName="user_tags">
            <column name="key" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="index_users_tags_value"
                     tableName="user_tags">
            <column name="value" type="varchar(255)"/>
        </createIndex>
    </changeSet>

    <changeSet id="15" author="skills team" context="migration15">
        <addColumn tableName="skill_definition">
            <column name="num_skills_required" type="int" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="skill_definition">
            <!-- optional, only used for skill groups -->
            <column name="group_id" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="user_points">
            <column name="contributes_to_skills_group" type="varchar(255)"/>
        </addColumn>
        <createIndex indexName="index_user_points_contributes_to_skills_group"
                     tableName="user_points">
            <column name="contributes_to_skills_group" type="varchar(255)"/>
        </createIndex>
    </changeSet>

    <changeSet id="16" author="skills team" context="migration16">
        <sql>
            update skill_definition set enabled = 'true' where enabled is null;
        </sql>
        <addNotNullConstraint columnDataType="varchar(255)" columnName="enabled" tableName="skill_definition"/>
    </changeSet>

    <changeSet id="17" author="skills team" context="migration17">
        <sql>
            update skill_definition set enabled = 'true' where enabled = 'false' and type = 'Skill' and group_id is null;
        </sql>
    </changeSet>

    <changeSet id="18" author="skills team" context="migration18">
        <renameTable newTableName="user_token"
                     oldTableName="password_reset_token"/>

        <addColumn tableName="user_token">
            <column name="type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="user_attrs">
            <column name="email_verified" type="varchar(255)" defaultValueBoolean="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="19" author="skills team" context="migration19">
        <dropForeignKeyConstraint baseTableName="user_token" constraintName="fk_password_reset_token_user_id" />
        <dropIndex tableName="user_token" indexName="index_password_reset_token_user_id" />
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="user_token"
                                 constraintName="fk_password_reset_token_user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="users"/>
    </changeSet>

    <changeSet id="20" author="skills team" context="migration20">
        <addColumn tableName="skill_definition">
            <column name="read_only" type="varchar(255)" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="skill_definition">
            <column name="copied_from_skill_ref" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="skill_definition">
            <column name="copied_from_project_id" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="copied_from_skill_ref"
                                 baseTableName="skill_definition"
                                 constraintName="fk_original_skill_skill_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>
        <addForeignKeyConstraint baseColumnNames="copied_from_project_id"
                                 baseTableName="skill_definition"
                                 constraintName="fk_skill_definition_project_definition_copy_from_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>
        <createIndex indexName="index_skill_definition_copied_from_project_id"
                     tableName="skill_definition">
            <column name="copied_from_project_id" type="varchar(255)"/>
        </createIndex>

        <createTable tableName="exported_skills">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="skill_ref_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="exported_from_project_id" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="skill_updated_queue">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="skill_ref_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="is_catalog_skill" type="varchar(255)" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="skill_ref_id"
                                 baseTableName="exported_skills"
                                 constraintName="fk_exported_skills_skill_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>

        <addForeignKeyConstraint baseColumnNames="exported_from_project_id"
                                 baseTableName="exported_skills"
                                 constraintName="fk_exported_skills_project_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="project_id"
                                 referencedTableName="project_definition"/>

        <addForeignKeyConstraint baseColumnNames="skill_ref_id"
                                 baseTableName="skill_updated_queue"
                                 constraintName="fk_skill_updated_queue_skill_ref_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="skill_definition"/>

        <createIndex indexName="index_exported_skills_exported_from_project_id"
                     tableName="exported_skills">
            <column name="exported_from_project_id" type="varchar(255)"/>
        </createIndex>

        <createIndex indexName="index_exported_skills_skill_ref_id" tableName="exported_skills">
            <column name="skill_ref_id" type="int"/>
        </createIndex>

        <insert tableName="skills_db_locks">
            <column name="lock" type="varchar(255)" value="catalog_skill_update_lock"/>
        </insert>

    </changeSet>
</databaseChangeLog>
